/**
 * sofa-state-resolver-service - v0.4.2 - Thu Feb 19 2015 14:17:46 GMT+0100 (CET)
 * http://www.sofa.io
 *
 * Copyright (c) 2014 CouchCommerce GmbH (http://www.couchcommerce.com / http://www.sofa.io) and other contributors
 * THIS SOFTWARE CONTAINS COMPONENTS OF THE SOFA.IO COUCHCOMMERCE SDK (WWW.SOFA.IO)
 * IT IS PROVIDED UNDER THE LICENSE TERMS OF THE ATTACHED LICENSE.TXT.
 */
!function(t){"use strict";t.define("sofa.StateResolver",function(e,r,a){var o=a.get("esEndpoint")+"_search?&size=1",n=function(e,r){var a=t.Util.find(e,function(t){return t.productUrl===r});return a.categoryId};return function(t){var a={query:{filtered:{filter:{or:[{term:{route:t}},{nested:{path:"routes",filter:{term:{"routes.productUrl":t}}}}]}}}};return r({method:"POST",url:o,data:a}).then(function(r){var a,o,u=r.data.hits.hits;return r.data.hits.hits.length?(a=u[0]._type,o=u[0]._source,"category"===a?{data:{url:t,stateName:"categories",stateParams:{categoryId:o.id}}}:"product"===a?{data:{url:t,stateName:"product",stateParams:{categoryId:n(o.routes,t),productId:o.id}}}:void 0):e.reject("can not resolve state")})}}),t.define("sofa.StateResolverService",function(e,r,a){var o={},n=new t.StateResolver(e,r,a),u={};return o.registerState=function(t){u[t.url]=t},o.resolveState=function(t){var r=e.defer();return u[t]?r.resolve(u[t]):n(t).then(function(t){r.resolve(t.data)},function(){r.reject()}),r.promise},o})}(sofa,document);